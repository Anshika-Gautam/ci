#!/bin/bash

set -e

. ~/virtualenv/bin/activate

export CI_DIR=/home/ubuntu/ci
export PYTHONPATH=/tmp/st2/st2common:${PYTHONPATH}
export PACK_NAME=$(~/virtualenv/bin/python ~/ci/.circle/validate.py "${CIRCLE_PROJECT_REPONAME}" pack.yaml)

if [[ -z "${PACK_NAME}" ]]
then
  echo "Unable to retrieve pack name."
  exit 1
fi

cp ~/ci/.circle/Makefile .
make all

echo "Validated $PACK_NAME"
echo "export PACK_NAME=$PACK_NAME" >> ~/.circlerc
